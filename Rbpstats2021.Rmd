---
title: "Analyse BP World Energy Statistics 2021"
author: "GeoffRussell"
date: "13/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(readxl)
library(plotly)
library(ggrepel)
```

## Introduction 

This code analyses data in the BP 
Statistical Review of World Energy spreadsheet; 
for the year 2021. 

## Read the data 

The names of the sheets
change from time to time, so when 2022 comes out the code may have to be adjusted.


```{r data}
bpfile<-"bp-stats-review-2021-all-data.xlsx"
s21<-excel_sheets(bpfile)
print(s21)
```
## Population data

We will be calculating per-capita statistics so need some population data.

We use a download of the 2020 World Bank Population data. It's latest year is 2019, so we use a polynomial model
to extrapolate for years after that; out to 2040. It's not the world's best population growth model, but good
enough for our purposes.

One wrinkle is that the World Bank country names don't match the BP country names. So we change
names of things we may need.

```{r pop}
dfpop<-read_csv("API_SP.POP.TOTL_DS2_en_csv_v2_2252106.csv",skip=4,show_col_types=FALSE) %>% rename(Country=`Country Name`)
dfpop$Country <- gsub("United States","US",dfpop$Country)
dfpop$Country <- gsub("Korea, Rep.","South Korea",dfpop$Country)
dfpop$Country <- gsub("Slovak Republic","Slovakia",dfpop$Country)
```



```{r}
#------------------------------------------------------------------------------------------------
# getpop returns a closure which is vectorised, we extrapolate past the last data point, 2019
# we unname pred because we don't need names and they confuse me when looking at structures!
#------------------------------------------------------------------------------------------------
getpop<-function(country) {
  f<-function(yr) {
    rp<-dfpop %>% filter(Country==country) %>% pivot_longer(names_to="year",cols="1960":"2019") %>% select(year,value)
    m1<-lm(value~poly(as.numeric(year),2),rp)
    df<-tibble(year=seq(1960,2040),Country=country)
    rowp<-df %>% add_predictions(m1) %>% filter(year %in% yr) %>% mutate(Year=year,Popn=unname(pred)) %>% select(-year,-pred) 
  }
}
getPopForList<-function(countries,years=seq(1975,2021)) {
  df<-tibble()
  for(c in countries) {
    df<-bind_rows(df,getpop(c)(years))
  }
  df$Popn<-unname(df$Popn)
  df 
}
# Here's a test call
tgetpop<-getpop("Australia")(1975:2000)
tgetPopForList<-getPopForList(c("Australia","Germany","France","US"))
```

## Compare historical energy roll out speeds

The first task in this project is to compare renewable and nuclear roll out speeds. I've done a few
such graphs in the past, but I'm doing it again to improve my R skills. 

The most rapid nuclear rollout various between countries, but it is roughly 1975-1990 in France. So we get
data between 1975 and 2020 for various technologies and compare rates.


```{r }
# plenty of data juggling due to how read_excel names its columns
# this code will have to change in 2022!
f<-function(.data,name,startyear="1975",endyear="2020...57") {
  rename(.data,Country=`Terawatt-hours`) %>% mutate(Type=name) %>% filter(!is.na(Country)) %>% 
    filter(!grepl("^Total ",Country)) %>% filter(!grepl("^Other ",Country)) %>% slice(1:84) %>% 
    select(Country,'Type',startyear:endyear) %>% rename('2020'=endyear) %>% 
    pivot_longer(startyear:'2020',names_to="yy",values_to="TWh") %>% filter(!is.na(TWh))
}
getSheet<-function(sheetname,cols,label,startyear="1975") {
    endyear<-paste0("2020...",toString(cols-3))
    read_excel(bpfile,sheet=sheetname,skip=2,na='n/a',col_types=c('text',rep('numeric',cols-1))) %>%
            f(label,startyear=startyear,endyear=endyear) 
}
# We pull out all the electricity data, and will decide what to keep later
# the data for electricity from Gas, Coal and Oil starts in 1985, instead of
# 1965, which is annoying
twh<-bind_rows(
    getSheet("Elec Gen from Gas",40,'Gas',startyear="1985"),
    getSheet("Elec Gen from Coal",40,'Coal',startyear="1985"),
    getSheet("Elec Gen from Oil",40,'Oil',startyear="1985"),
    getSheet("Solar Generation - TWh",60,'Solar'),
    getSheet("Wind Generation - TWh",60,'Wind'),
    getSheet("Hydro Generation - TWh",60,'Hydro'),
    getSheet("Nuclear Generation - TWh",60,'Nuclear'),
    getSheet("Geo Biomass Other - TWh",60,'Biomass/Geo')
  ) %>% mutate(Year=as.numeric(yy)) %>% select(-yy) 
```

```{r}
#-----------------------------------------------
# Augment twh with sums of various columns
#-----------------------------------------------
twhEx<-twh %>% pivot_wider(names_from=c("Type"),values_from="TWh") %>%
  mutate(SolarPlusWind=Solar+Wind,SolarPlusWindPlusBio=Solar+Wind+`Biomass/Geo`) %>%
  pivot_longer(cols=`Gas`:`SolarPlusWindPlusBio`,names_to="Type",values_to="TWh")

mergePopData<-function(.data,countries) {
    dfc<-getPopForList(countries)
    .data %>% filter(Country %in% countries) %>% left_join(dfc)
}
#----------------------------------------------------------------------
# Remove any countries in twh for which we don't have population data
#---------------------------------------------------------------------
removeMissing<-function(.data,df) {
  semi_join(.data,df %>% select(Country),by=c("Country")) 
}
twh <- twh %>% removeMissing(dfpop) 
clist<-twh %>% select(Country) %>% unique()
#---------------------------------------------------------------------------
# Now we can augment the data with population and calculate perCap numbers
#---------------------------------------------------------------------------
fulldf<-twh %>% mergePopData(clist$Country) %>% mutate(MWhPerCap=TWh*1e12/Popn/1e6)
fulldfEx<-twhEx %>% mergePopData(clist$Country) %>% mutate(MWhPerCap=TWh*1e12/Popn/1e6)
```

```{r}
#-------------------------------------------------------------------------
# Now we nest the data for each Country,Type
#-------------------------------------------------------------------------
nst<-fulldfEx %>% group_by(Country,Type) %>% arrange(Year) %>% nest()
#----------------------------------------------------------
# Now we can calculate the lag increment for each country and type
# NB slice only works on ungrouped data 
#----------------------------------------------------------
comma<-function(x) prettyNum(signif(x,digits=4),big.mark=",")
mnst<-nst %>% mutate(data=map(data,~mutate(.x,inc=.$MWhPerCap-lag(.$MWhPerCap,15)))) 
mnstmax<-mnst %>% mutate(Max=map_dbl(data, ~ max(replace_na(.x$inc,0),na.rm=TRUE)),
                         MaxYear=map(data, ~ .$Year[which.max(replace_na(.x$inc,0))]))
top15<-mnstmax %>% filter(Type!="SolarPlusWindPlusBio") %>% arrange(desc(Max)) %>% 
  select(Country,Type,MaxYear,Max) %>% ungroup() %>% slice_head(n=15) 
p<-top15 %>% ggplot(aes(x=as.numeric(MaxYear),y=Max))+
  geom_point(aes(color=Type),size=7)+
  geom_text_repel(aes(x=as.numeric(MaxYear),y=Max,label=paste0(Country," ",comma(Max))),size=3)+
  labs(x="Year",y="Max MWh/cap over 15 years",title="Global record energy growth rates (top 15)")
p
png("top25-over-15-years.png",width=1800,height=1800,units="px",res=300,type="cairo-png")
p
dev.off()
```
```{r}
#-------------------------------------------------------------------------
# At this point we could go searching for top countries, but for now we just
# select interesting ones
#-------------------------------------------------------------------------
selectedCountries<-mnst %>% unnest(cols=c(data)) %>% 
  filter(Country %in% c("France","Germany","US","Sweden","Belgium","United Kingdom")) %>%
  filter(Type %in% c("Nuclear","SolarPlusWind","SolarPlusWindPlusBio","Hydro")) 
p<-selectedCountries %>% ggplot(aes(x=Year,y=inc,color=Type)) + geom_line(size=0.3) + facet_wrap(~Country) + 
  labs(y="Increase in Megawatt-hours per person over 5 years",title="Electrical energy change by source (data: BP Stats 2021)")+
  theme(axis.title=element_text(size=7),axis.text.x=element_text(size=7))
p
png("megawatt-hours-per-person-increase.png",width=1800,height=800,units="px",res=300,type="cairo-png")
p
dev.off()
```

```{r}
#---------------------------------------------------------
# The above graphs are better, but this next is interesting
# because of it's use of two legends in the graph. It also
# has the advantage of not showing things relative to zero;
# which can confuse some people.
#---------------------------------------------------------
# twh has data for all countries and mergePopData will filter out
# a selected set and add in the population data
#---------------------------------------------------------
ctwh<-twh %>% mergePopData(c("Australia","US","France","Germany","Belgium","Sweden"))
totaltwh <- ctwh %>% group_by(Country,Year) %>% summarise(total=sum(TWh)) %>% 
  select(Country,Year,total) %>% left_join(ctwh %>% select(Country,Year,Popn) %>% unique()) 

p<-ctwh %>% filter(!Type %in% c("Gas","Coal","Oil")) %>% ggplot(aes(x=Year,y=TWh*1e12/Popn/1e6))+
  geom_col(aes(fill=Type))+geom_line(aes(x=Year,y=total*1e12/Popn/1e6,color="black"),data=totaltwh)+
  guides(fill=guide_legend("Show only"),color=guide_legend(""))+
  scale_color_manual(values=c("black"),labels="Total")+
  facet_wrap(~Country)+
  labs(y="Megawatt-hours per capita from clean(ish) energy sources",
       title="Electricity production by source (Data: BP Stats 2021) ")+
  theme(axis.title=element_text(size=7),axis.text.x=element_text(size=7))
p
#--------------------------------------------------------------------------------------
# now make a png for posting
#--------------------------------------------------------------------------------------
png("cleanish-megawatt-hours-per-person.png",width=1800,height=800,units="px",res=300,type="cairo-png")
p
dev.off()
```


